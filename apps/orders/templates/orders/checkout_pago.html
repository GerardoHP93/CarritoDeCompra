<!-- apps/orders/templates/orders/checkout_pago.html -->
{% extends 'base.html' %}

{% block title %}Método de Pago | Market Digital{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4">Proceso de Compra</h2>

    <!-- Pasos del proceso de compra -->
    <div class="checkout-steps mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="step">
                    <div class="step-icon">
                        <i class="bi bi-geo-alt"></i>
                    </div>
                    <div class="step-text">Elegir domicilio</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="step active">
                    <div class="step-icon">
                        <i class="bi bi-credit-card"></i>
                    </div>
                    <div class="step-text">Elegir forma de pago</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="step">
                    <div class="step-icon">
                        <i class="bi bi-list-check"></i>
                    </div>
                    <div class="step-text">Resumen de orden</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="step">
                    <div class="step-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="step-text">Confirmación</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Método de Pago</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="formPago">
                        {% csrf_token %}

                        <div class="mb-4">
                            <label for="{{ form.metodo_pago.id_for_label }}" class="form-label">Selecciona tu método de
                                pago</label>
                            {{ form.metodo_pago }}
                            {% if form.metodo_pago.errors %}
                            <div class="invalid-feedback d-block">{{ form.metodo_pago.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Sección Tarjeta de Crédito/Débito -->
                        <div id="seccionTarjeta" style="display: none;">
                            <h5 class="mb-3">Información de la Tarjeta</h5>

                            <div class="mb-3">
                                <label for="{{ form.tipo_tarjeta.id_for_label }}" class="form-label">Tipo de
                                    tarjeta</label>
                                {{ form.tipo_tarjeta }}
                                {% if form.tipo_tarjeta.errors %}
                                <div class="invalid-feedback d-block">{{ form.tipo_tarjeta.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.numero_tarjeta.id_for_label }}" class="form-label">Número de
                                    tarjeta</label>
                                <div class="input-group">
                                    <span class="input-group-text" id="iconoTarjeta">
                                        <i class="bi bi-credit-card"></i>
                                    </span>
                                    {{ form.numero_tarjeta }}
                                </div>
                                {% if form.numero_tarjeta.errors %}
                                <div class="invalid-feedback d-block">{{ form.numero_tarjeta.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.titular_tarjeta.id_for_label }}" class="form-label">Nombre del
                                    titular</label>
                                {{ form.titular_tarjeta }}
                                {% if form.titular_tarjeta.errors %}
                                <div class="invalid-feedback d-block">{{ form.titular_tarjeta.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.fecha_expiracion.id_for_label }}" class="form-label">Fecha de
                                        expiración</label>
                                    {{ form.fecha_expiracion }}
                                    {% if form.fecha_expiracion.errors %}
                                    <div class="invalid-feedback d-block">{{ form.fecha_expiracion.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted">MM/AA</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.cvv.id_for_label }}" class="form-label">CVV</label>
                                    {{ form.cvv }}
                                    {% if form.cvv.errors %}
                                    <div class="invalid-feedback d-block">{{ form.cvv.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted">3 o 4 dígitos en el reverso de la tarjeta</small>
                                </div>
                            </div>
                        </div>

                        <!-- Sección PayPal -->
                        <div id="seccionPaypal" style="display: none;">
                            <div class="text-center py-4">
                                <img src="https://www.paypalobjects.com/webstatic/en_US/i/buttons/checkout-logo-large.png"
                                    alt="PayPal Checkout" class="img-fluid" style="max-width: 200px;">
                                <p class="mt-3">Al continuar, serás redirigido a PayPal para completar tu compra de
                                    forma segura.</p>
                                <p class="text-muted small">NOTA: En esta versión de demostración, no se realizará una
                                    redirección real.</p>
                            </div>
                        </div>

                        <!-- apps/orders/templates/orders/checkout_pago.html (corregir enlace de retroceso) -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'orders:checkout_direccion' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i> Volver a dirección
                            </a>
                            <button type="submit" class="btn btn-primary">
                                Continuar al resumen <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Resumen del Pedido</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h5 class="border-bottom pb-2">Dirección de Envío</h5>
                        <p class="mb-0">
                            {{ request.session.direccion_completa.nombre_completo }}<br>
                            {{ request.session.direccion_completa.calle }} {{
                            request.session.direccion_completa.numero_exterior }}
                            {% if request.session.direccion_completa.numero_interior %}, Int. {{
                            request.session.direccion_completa.numero_interior }}{% endif %}<br>
                            {{ request.session.direccion_completa.colonia }}, {{
                            request.session.direccion_completa.ciudad }}<br>
                            {{ request.session.direccion_completa.estado }}, {{ request.session.direccion_completa.pais
                            }}<br>
                            C.P. {{ request.session.direccion_completa.codigo_postal }}<br>
                            Tel: {{ request.session.direccion_completa.telefono_contacto }}
                        </p>
                    </div>

                    <h5 class="border-bottom pb-2">Resumen del Carrito</h5>
                    <ul class="list-group list-group-flush mb-3">
                        {% for item in cart_items %}
                        <li class="list-group-item d-flex justify-content-between lh-sm">
                            <div>
                                <h6 class="my-0">{{ item.producto.nombre }}</h6>
                                <small class="text-muted">{{ item.cantidad }} x ${{ item.producto.precio }}</small>
                            </div>
                            <span class="text-muted">${{ item.subtotal }}</span>
                        </li>
                        {% endfor %}
                        <li class="list-group-item d-flex justify-content-between bg-light">
                            <div class="text-success">
                                <h6 class="my-0">Total</h6>
                            </div>
                            <span class="text-success fw-bold">${{ cart.total }}</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="mt-4">
                <div class="card border-0 shadow">
                    <div class="card-body">
                        <h5 class="mb-3">Métodos de Pago Aceptados</h5>
                        <div class="d-flex justify-content-around">
                            <i class="bi bi-credit-card fs-2 text-primary"></i>
                            <i class="bi bi-paypal fs-2 text-primary"></i>
                        </div>
                        <div class="mt-3 d-flex gap-2 justify-content-center">
                            <img src="https://cdn.visa.com/v2/assets/images/logos/visa/logo.png" alt="Visa" height="30">
                            <img src="https://www.mastercard.com/content/dam/public/brandcenter/en/images-and-assets/cards/mc-logo-52.svg"
                                alt="MasterCard" height="30">
                            <img src="https://www.americanexpress.com/content/dam/amex/us/merchant/AmexLogo.jpg"
                                alt="American Express" height="30">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const metodoPago = document.getElementById('{{ form.metodo_pago.id_for_label }}');
        const seccionTarjeta = document.getElementById('seccionTarjeta');
        const seccionPaypal = document.getElementById('seccionPaypal');
        const tipoTarjeta = document.getElementById('{{ form.tipo_tarjeta.id_for_label }}');
        const iconoTarjeta = document.getElementById('iconoTarjeta');

        // Cambiar secciones según método de pago
        metodoPago.addEventListener('change', function () {
            if (this.value === 'tarjeta') {
                seccionTarjeta.style.display = 'block';
                seccionPaypal.style.display = 'none';
            } else if (this.value === 'paypal') {
                seccionTarjeta.style.display = 'none';
                seccionPaypal.style.display = 'block';
            } else {
                seccionTarjeta.style.display = 'none';
                seccionPaypal.style.display = 'none';
            }
        });

        // Cambiar ícono según tipo de tarjeta
        if (tipoTarjeta) {
            tipoTarjeta.addEventListener('change', function () {
                if (iconoTarjeta) {
                    let icon = 'bi-credit-card';

                    switch (this.value) {
                        case 'visa':
                            icon = 'bi-credit-card-2-front';
                            break;
                        case 'mastercard':
                            icon = 'bi-credit-card-2-back';
                            break;
                        case 'amex':
                            icon = 'bi-credit-card-fill';
                            break;
                    }

                    iconoTarjeta.innerHTML = `<i class="bi ${icon}"></i>`;
                }
            });
        }

        // Autoformato de número de tarjeta
        const numeroTarjeta = document.getElementById('{{ form.numero_tarjeta.id_for_label }}');
        if (numeroTarjeta) {
            numeroTarjeta.addEventListener('input', function (e) {
                // Eliminar caracteres no numéricos
                let value = this.value.replace(/\D/g, '');

                // Añadir espacios cada 4 dígitos
                value = value.replace(/(\d{4})(?=\d)/g, '$1 ');

                // Limitar a 19 caracteres (16 dígitos + 3 espacios)
                if (value.length > 19) {
                    value = value.substr(0, 19);
                }

                this.value = value;
            });
        }

        // Autoformato de fecha de expiración
        const fechaExpiracion = document.getElementById('{{ form.fecha_expiracion.id_for_label }}');
        if (fechaExpiracion) {
            fechaExpiracion.addEventListener('input', function (e) {
                // Eliminar caracteres no numéricos
                let value = this.value.replace(/\D/g, '');

                // Añadir diagonal después de los primeros 2 dígitos
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                }

                // Limitar a 5 caracteres (MM/AA)
                if (value.length > 5) {
                    value = value.substr(0, 5);
                }

                this.value = value;
            });
        }

        // Validar formulario antes de enviar
        const formPago = document.getElementById('formPago');
        if (formPago) {
            formPago.addEventListener('submit', function (e) {
                const metodo = metodoPago.value;

                if (!metodo) {
                    e.preventDefault();
                    Swal.fire({
                        title: 'Error',
                        text: 'Debes seleccionar un método de pago',
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });
                    return false;
                }

                if (metodo === 'tarjeta') {
                    // Validar campos de tarjeta
                    const campos = [
                        { id: '{{ form.tipo_tarjeta.id_for_label }}', nombre: 'tipo de tarjeta' },
                        { id: '{{ form.numero_tarjeta.id_for_label }}', nombre: 'número de tarjeta' },
                        { id: '{{ form.titular_tarjeta.id_for_label }}', nombre: 'titular de la tarjeta' },
                        { id: '{{ form.fecha_expiracion.id_for_label }}', nombre: 'fecha de expiración' },
                        { id: '{{ form.cvv.id_for_label }}', nombre: 'CVV' }
                    ];

                    for (const campo of campos) {
                        const elemento = document.getElementById(campo.id);
                        if (!elemento.value) {
                            e.preventDefault();
                            Swal.fire({
                                title: 'Error',
                                text: `Debes ingresar el ${campo.nombre}`,
                                icon: 'error',
                                confirmButtonText: 'Entendido'
                            });
                            elemento.focus();
                            return false;
                        }
                    }
                }
            });
        }

        // Inicializar estado según valor actual del método de pago
        if (metodoPago.value) {
            const event = new Event('change');
            metodoPago.dispatchEvent(event);
        }
    });
</script>
{% endblock %}
{% endblock %}